<div class="container">
    <!-- Panel Izquierdo - Lista de Apiarios -->
    <div class="left-panel">
        <div class="panel-header">
            <h2><span>üêù</span> Apiarios</h2>
            <button class="btn-nuevo-apiario" (click)="abrirModalApiario()">
                <span>‚ûï</span> Nuevo
            </button>
        </div>
        
        <div class="search-box">
            <input 
                type="text" 
                placeholder="Buscar por n√∫mero, tipo o ID..."
                [(ngModel)]="terminoBusqueda"
            />
            <span class="search-icon">üîç</span>
        </div>
        
        <div class="apiarios-lista">
            <div 
                *ngFor="let apiario of filtrarApiarios()" 
                class="apiario-item"
                [class.active]="apiarioSeleccionado?.id === apiario.id"
                (click)="seleccionarApiario(apiario)">
                <div class="apiario-header">
                    <span class="apiario-numero">Apiario #{{ apiario.numeroApiario }}</span>
                    <span class="apiario-badge" [ngClass]="obtenerClaseBadge(apiario.salud)">
                        {{ apiario.salud }}
                    </span>
                </div>
                <div class="apiario-datos">
                    <div class="dato-row">
                        <span class="dato-label">üìç Ubicaci√≥n:</span>
                        <span class="dato-valor">{{ apiario.ubicacion }}</span>
                    </div>
                    <div class="dato-row">
                        <span class="dato-label">üíä Receta:</span>
                        <span class="dato-valor">{{ apiario.receta ? 'Activa' : 'Sin receta' }}</span>
                    </div>
                    <div class="dato-row">
                        <span class="dato-label">üìã Historial:</span>
                        <span class="dato-valor">{{ contarMedicamentos(apiario) }} medicamentos</span>
                    </div>
                    <!-- üîó Mostrar dispositivo vinculado -->
                    <div class="dato-row" *ngIf="apiario.dispositivoId">
                        <span class="dato-label">üì± Dispositivo:</span>
                        <span class="dato-valor">{{ apiario.dispositivoId }}</span>
                    </div>
                </div>
                <div class="botones-container">
                    <button class="btn btn-editar" (click)="editarApiario(apiario, $event)">‚úèÔ∏è Editar</button>
                    <button class="btn btn-receta" (click)="abrirModalReceta(apiario, $event)">üíä Receta</button>
                    <button class="btn btn-eliminar" (click)="eliminarApiario(apiario, $event)">üóëÔ∏è Eliminar</button>
                </div>
            </div>

            <!-- Estados vac√≠os actualizados -->
            <div *ngIf="cargando" class="empty-state">
                <div class="empty-state-icon">‚è≥</div>
                <p>Cargando apiarios...</p>
            </div>

            <div *ngIf="!cargando && apiarios.length === 0" class="empty-state">
                <div class="empty-state-icon">üêù</div>
                <p>No hay apiarios registrados</p>
            </div>

            <div *ngIf="!cargando && apiarios.length > 0 && filtrarApiarios().length === 0 && terminoBusqueda.trim()" class="empty-state">
                <div class="empty-state-icon">üîç</div>
                <p>No se encontraron apiarios con "{{terminoBusqueda}}"</p>
                <button class="btn btn-limpiar" (click)="terminoBusqueda = ''">Limpiar b√∫squeda</button>
            </div>
        </div>
    </div>

    <!-- Panel Derecho - Detalles y Gesti√≥n ESP32 -->
    <div class="right-panel">
        <!-- Detalles del Apiario -->
        <div class="detalle-container">
            <div class="detalle-header">
                <h3 *ngIf="!apiarioSeleccionado">üêù Selecciona un apiario</h3>
                <h3 *ngIf="apiarioSeleccionado">
                    üêù Apiario #{{ apiarioSeleccionado.numeroApiario }} - {{ apiarioSeleccionado.ubicacion }}
                </h3>
                <button class="btn-sugerencias" (click)="abrirModalSugerencias()">
                    üí° Sugerencias IA
                </button>
            </div>

            <!-- Estado vac√≠o -->
            <div *ngIf="!apiarioSeleccionado" class="empty-state">
                <div class="empty-state-icon">üêù</div>
                <p>Selecciona un apiario de la lista para ver sus detalles</p>
            </div>

            <!-- Detalles del apiario seleccionado -->
            <div *ngIf="apiarioSeleccionado" class="info-section">
                <!-- Informaci√≥n General -->
                <div class="info-card">
                    <div class="info-title">üìä Informaci√≥n General</div>
                    <div class="info-content">
                        <div class="dato-row">
                            <span class="dato-label">Estado de Salud:</span>
                            <span class="dato-valor">{{ apiarioSeleccionado.salud }}</span>
                        </div>
                        <div class="dato-row">
                            <span class="dato-label">Ubicaci√≥n:</span>
                            <span class="dato-valor">{{ apiarioSeleccionado.ubicacion }}</span>
                        </div>
                        <!-- üîó Informaci√≥n del dispositivo vinculado -->
                        <div class="dato-row" *ngIf="apiarioSeleccionado.dispositivoId">
                            <span class="dato-label">üì± Dispositivo:</span>
                            <span class="dato-valor">{{ apiarioSeleccionado.dispositivoId }}</span>
                        </div>
                        <div class="dato-row" *ngIf="apiarioSeleccionado.fechaVinculacion">
                            <span class="dato-label">üìÖ Vinculado:</span>
                            <span class="dato-valor">{{ formatearFecha(apiarioSeleccionado.fechaVinculacion) }}</span>
                        </div>
                    </div>
                </div>

                <!-- Receta Activa -->
                <div *ngIf="apiarioSeleccionado.receta" class="info-card receta-activa">
                    <div class="info-title">üíä Receta Activa</div>
                    <div class="info-content">
                        <div class="dato-row">
                            <span class="dato-label">Descripci√≥n:</span>
                            <span class="dato-valor">{{ apiarioSeleccionado.receta.descripcion }}</span>
                        </div>
                        <div class="dato-row">
                            <span class="dato-label">Fecha:</span>
                            <span class="dato-valor">{{ formatearFecha(apiarioSeleccionado.receta.fechaDeCreacion) }}</span>
                        </div>
                        <div class="dato-row">
                            <span class="dato-label">Medicamentos:</span>
                            <span class="dato-valor">{{ contarMedicamentos(apiarioSeleccionado) }}</span>
                        </div>
                        
                        <button class="btn btn-eliminar" style="width: 100%; margin-top: 15px;" 
                                (click)="eliminarReceta(apiarioSeleccionado)">
                            Marcar como Cumplida
                        </button>
                    </div>
                </div>

                <!-- Sin Receta -->
                <div *ngIf="!apiarioSeleccionado.receta" class="info-card">
                    <div class="info-title">üíä Sin Receta Activa</div>
                    <div class="info-content">
                        <p>Este apiario no tiene recetas m√©dicas activas en este momento.</p>
                    </div>
                </div>

                <!-- Historial M√©dico -->
                <div class="info-card">
                    <div class="info-title">üìã Historial M√©dico</div>
                    <div class="info-content">
                        <div *ngIf="apiarioSeleccionado.historialMedico">
                            <div class="dato-row">
                                <span class="dato-label">Fecha:</span>
                                <span class="dato-valor">{{ formatearFecha(apiarioSeleccionado.historialMedico.fechaAplicacion) }}</span>
                            </div>
                            <div class="dato-row">
                                <span class="dato-label">Notas:</span>
                                <span class="dato-valor">{{ apiarioSeleccionado.historialMedico.notas || 'Sin notas' }}</span>
                            </div>
                        </div>
                        <p *ngIf="!apiarioSeleccionado.historialMedico">
                            Sin registros en el historial m√©dico.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gesti√≥n ESP32 - ACTUALIZADO -->
        <div class="gestion-esp32-container">
            <div class="gestion-header">
                <h3>‚ö° Control ESP32</h3>
              
            </div>

            <!-- Estado de carga -->
            <div *ngIf="cargandoDispositivos" class="loading-container">
                <div class="spinner"></div>
                <p>Buscando dispositivos ESP32...</p>
            </div>

            <!-- Sin dispositivo vinculado -->
            <div *ngIf="!cargandoDispositivos && !apiarioSeleccionado?.dispositivoId" class="no-device">
                <div class="no-device-icon"></div>
                <p>Selecciona un apiario para operar</p>
               
            </div>

            <!-- Panel de control del dispositivo - ACTUALIZADO -->
            <div *ngIf="!cargandoDispositivos && apiarioSeleccionado?.dispositivoId" class="control-panel">
                <!-- Informaci√≥n del dispositivo -->
                <div class="device-info">
                    <div class="device-id">
                        <strong>ID:</strong> {{ apiarioSeleccionado?.dispositivoId }}
                    </div>
                   
                </div>

                <!-- Controles de hardware - ACTUALIZADOS -->
                <div class="hardware-controls">
                    <!-- Control de Ventilador (Motor A) -->
                    <div class="control-group">
                        <label>üåÄ Ventilador</label>
                        <div class="control-buttons">
                            <button class="btn-control" 
                                    [class.active]="estadoVentilador"
                                    (click)="controlarVentilador(true)">
                                ENCENDER
                            </button>
                            <button class="btn-control" 
                                    [class.active]="!estadoVentilador"
                                    (click)="controlarVentilador(false)">
                                APAGAR
                            </button>
                        </div>
                    </div>

                   
                    <!-- Control de Luz -->
                    <div class="control-group">
                        <label>üí° Luz</label>
                        <div class="control-buttons">
                            <button class="btn-control" 
                                    [class.active]="estadoLuz"
                                    (click)="controlarLuz(true)">
                                ENCENDER
                            </button>
                            <button class="btn-control" 
                                    [class.active]="!estadoLuz"
                                    (click)="controlarLuz(false)">
                                APAGAR
                            </button>
                        </div>
                    </div>

                    <!-- Control de Servos -->
                    <div class="control-group">
                        <label>üîß Servo 1</label>
                        <div class="servo-control">
                            <input type="range" min="0" max="180" [(ngModel)]="servo1Grados" 
                                   class="servo-slider" (change)="controlarServo1(servo1Grados)">
                            <span class="servo-value">{{ servo1Grados }}¬∞</span>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>üîß Servo 2</label>
                        <div class="servo-control">
                            <input type="range" min="0" max="180" [(ngModel)]="servo2Grados" 
                                   class="servo-slider" (change)="controlarServo2(servo2Grados)">
                            <span class="servo-value">{{ servo2Grados }}¬∞</span>
                        </div>
                    </div>

                    

                <!-- Estado de los sensores -->
                <!-- Estado de los sensores -->
<div class="sensors-status">
    <h4>üìä Sensores</h4>
    <div class="sensors-grid">
        <div class="sensor-item" *ngFor="let sensor of obtenerSensores()">
            <span class="sensor-name">{{ sensor.nombre }}</span>
            <span class="sensor-value">{{ sensor.valor }} {{ sensor.unidad }}</span>
        </div>
    </div>
</div>
            </div>
        </div>
    </div>

    <!-- Modal para Apiario -->
    <div class="modal-overlay" [class.active]="mostrarModalApiario">
        <div class="modal">
            <div class="modal-header">
                <h3>{{ apiarioEditando ? 'Editar Apiario' : 'Nuevo Apiario' }}</h3>
                <button class="btn-close" (click)="cerrarModalApiario()">√ó</button>
            </div>
            <form (ngSubmit)="guardarApiario()">
                <div class="form-group">
                    <label>N√∫mero de Apiario</label>
                    <input type="number" [(ngModel)]="formApiario.numeroApiario" 
                           name="numeroApiario" required placeholder="Ej: 1">
                </div>
                <div class="form-group">
                    <label>Ubicaci√≥n</label>
                    <input type="text" [(ngModel)]="formApiario.ubicacion" 
                           name="ubicacion" required placeholder="Ej: Campo Norte">
                </div>
                <div class="form-group">
                    <label>Estado de Salud</label>
                    <select [(ngModel)]="formApiario.salud" name="salud" required>
                        <option value="">Seleccione...</option>
                        <option value="Buena">Buena</option>
                        <option value="Regular">Regular</option>
                        <option value="Cr√≠tica">Cr√≠tica</option>
                    </select>
                </div>
                
                <!-- Selector de dispositivos -->
                <div class="form-group">
                    <label>üì± Dispositivos Disponibles</label>
                    <select [(ngModel)]="dispositivoSeleccionado" name="dispositivoId">
                        <option value="">Sin dispositivo</option>
                        <option *ngFor="let dispositivo of dispositivosDisponibles" 
                                [value]="dispositivo.dispositivoId">
                            {{ dispositivo.dispositivoId }} 
                            <span *ngIf="dispositivo.tipo">- {{ dispositivo.tipo }}</span>
                            <span *ngIf="dispositivo.sensores"> (Sensores: {{ dispositivo.sensores?.join(', ') }})</span>
                        </option>
                    </select>
                    <small class="text-hint" *ngIf="dispositivosDisponibles.length === 0">
                        No hay dispositivos detectados
                    </small>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-modal btn-cancelar" (click)="cerrarModalApiario()">Cancelar</button>
                    <button type="submit" class="btn-modal btn-guardar" [disabled]="cargando">
                        {{ cargando ? 'Guardando...' : 'Guardar' }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Receta -->
    <div class="modal-overlay" [class.active]="mostrarModalReceta">
        <div class="modal">
            <div class="modal-header">
                <h3>üíä Agregar Receta M√©dica</h3>
                <button class="btn-close" (click)="cerrarModalReceta()">√ó</button>
            </div>
            <form (ngSubmit)="guardarReceta()">
                <div class="form-group">
                    <label>üìù Descripci√≥n de la Receta</label>
                    <textarea [(ngModel)]="formReceta.descripcion" 
                              name="descripcion" rows="4" required
                              placeholder="Describe los s√≠ntomas, tratamiento y recomendaciones..."
                              class="descripcion-textarea"></textarea>
                </div>
                
                <!-- Lista din√°mica de medicamentos -->
                <div class="medicamentos-section">
                    <div class="section-header">
                        <label>üíä Medicamentos para la Receta</label>
                        <button type="button" class="btn-agregar" (click)="agregarMedicamento()" 
                                [disabled]="cargandoMedicamentos || medicamentosDisponibles.length === 0">
                            <span *ngIf="!cargandoMedicamentos">‚ûï</span>
                            <span *ngIf="cargandoMedicamentos">‚è≥</span>
                            {{ cargandoMedicamentos ? 'Cargando...' : 'Agregar Medicamento' }}
                        </button>
                    </div>

                    <!-- Estado de carga de medicamentos -->
                    <div *ngIf="cargandoMedicamentos" class="loading-medicamentos">
                        <div class="loading-spinner">‚è≥</div>
                        <p>Cargando lista de medicamentos disponibles...</p>
                    </div>

                    <!-- Estado sin medicamentos disponibles -->
                    <div *ngIf="!cargandoMedicamentos && medicamentosDisponibles.length === 0" class="no-medicamentos">
                        <div class="warning-icon">‚ö†Ô∏è</div>
                        <p>No hay medicamentos disponibles en el inventario</p>
                        <small>Agrega medicamentos al sistema antes de crear recetas</small>
                    </div>

                    <!-- Lista de medicamentos agregados -->
                    <div *ngIf="!cargandoMedicamentos && formReceta.medicamentos.length > 0">
                        <div *ngFor="let medicamento of formReceta.medicamentos; let i = index" 
                             class="medicamento-item">
                            <div class="medicamento-header">
                                <span class="medicamento-numero">Medicamento {{ i + 1 }}</span>
                                <button type="button" class="btn-eliminar-medicamento" 
                                        (click)="removerMedicamento(i)">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                            
                            <div class="form-group">
                                <label>Seleccionar Medicamento *</label>
                                <select 
                                    [(ngModel)]="medicamento.id" 
                                    [name]="'medicamentoId_' + i"
                                    required
                                    class="medicamento-select">
                                    <option [value]="0">-- Selecciona un medicamento --</option>
                                    <option *ngFor="let med of medicamentosDisponibles" 
                                            [value]="med.id"
                                            [disabled]="esMedicamentoDuplicado(med.id, i)">
                                        {{ med.nombre }} - {{ med.descripcion }} (Stock: {{ med.cantidad }})
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-modal btn-cancelar" (click)="cerrarModalReceta()" [disabled]="cargando">
                        ‚ùå Cancelar
                    </button>
                    <button type="submit" class="btn-modal btn-guardar" 
                            [disabled]="cargando || formReceta.medicamentos.length === 0 || cargandoMedicamentos || tieneMedicamentosInvalidos()">
                        <span *ngIf="!cargando">üíæ</span>
                        <span *ngIf="cargando">‚è≥</span>
                        {{ cargando ? 'Guardando...' : 'Guardar Receta' }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Vinculaci√≥n de Dispositivos -->
    <div class="modal-overlay" [class.active]="mostrarModalVinculacion">
        <div class="modal modal-vinculacion">
            <div class="modal-header">
                <h3>üîó Vincular Dispositivo ESP32</h3>
                <button class="btn-close" (click)="cerrarModalVinculacion()">√ó</button>
            </div>

            <div class="modal-content">
                <!-- Estado de conexi√≥n MQTT -->
                <div class="mqtt-status">
                    <div class="status-header">
                        <h4>üì° Estado MQTT</h4>
                        <span class="status-badge" [class.connected]="estadoMqtt === 'Conectado'" 
                              [class.disconnected]="estadoMqtt !== 'Conectado'">
                            {{ estadoMqtt || 'Verificando...' }}
                        </span>
                    </div>
                    <button class="btn btn-actualizar" (click)="actualizarEstadoMqtt()">
                        üîÑ Actualizar Estado
                    </button>
                </div>

                <!-- Dispositivos detectados -->
                <div class="dispositivos-section">
                    <div class="section-header">
                        <h4>üì± Dispositivos Detectados</h4>
                        <button class="btn btn-actualizar" (click)="actualizarDispositivos()">
                            üîÑ Buscar Dispositivos
                        </button>
                    </div>

                    <div *ngIf="cargandoDispositivos" class="loading-dispositivos">
                        <div class="spinner">‚è≥</div>
                        <p>Buscando dispositivos ESP32 en la red...</p>
                    </div>

                    <div *ngIf="!cargandoDispositivos && dispositivosDisponibles.length === 0" class="no-dispositivos">
                        <div class="no-device-icon">üîç</div>
                        <p>No se detectaron dispositivos ESP32</p>
                        <small>Verifica que los dispositivos est√©n encendidos y conectados a la red</small>
                    </div>

                    <div *ngIf="!cargandoDispositivos && dispositivosDisponibles.length > 0" class="dispositivos-lista">
                        <div *ngFor="let dispositivo of dispositivosDisponibles" 
                             class="dispositivo-item"
                             [class.seleccionado]="dispositivoVinculacion?.dispositivoId === dispositivo.dispositivoId"
                             (click)="seleccionarDispositivoParaVincular(dispositivo)">
                            <div class="dispositivo-header">
                                <span class="dispositivo-id">{{ dispositivo.dispositivoId }}</span>
                                <span class="dispositivo-estado" [class.online]="dispositivo.estado === 'online'">
                                    {{ dispositivo.estado || 'desconocido' }}
                                </span>
                            </div>
                            <div class="dispositivo-info">
                                <div class="info-row">
                                    <span class="info-label">Tipo:</span>
                                    <span class="info-value">{{ dispositivo.tipo || 'No especificado' }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">√öltima conexi√≥n:</span>
                                    <span class="info-value">{{ dispositivo.ultimaConexion || 'No disponible' }}</span>
                                </div>
                                <div class="info-row" *ngIf="dispositivo.sensores">
                                    <span class="info-label">Sensores:</span>
                                    <span class="info-value">{{ dispositivo.sensores.join(', ') }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Confirmaci√≥n de vinculaci√≥n -->
                <div *ngIf="dispositivoVinculacion" class="vinculacion-confirm">
                    <div class="confirm-header">
                        <h4>‚úÖ Confirmar Vinculaci√≥n</h4>
                    </div>
                    <div class="confirm-content">
                        <p>¬øVincular el dispositivo <strong>{{ dispositivoVinculacion.dispositivoId }}</strong> 
                        al apiario <strong>#{{ apiarioSeleccionado?.numeroApiario }}</strong>?</p>
                        
                        <div class="confirm-actions">
                            <button class="btn btn-cancelar" (click)="cancelarVinculacion()">
                                ‚ùå Cancelar
                            </button>
                            <button class="btn btn-confirmar" (click)="confirmarVinculacion()">
                                üîó Vincular
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>