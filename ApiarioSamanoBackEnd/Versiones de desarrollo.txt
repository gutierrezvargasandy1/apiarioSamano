Versiones de desarrollo 

Docker -- v4.47.0
java versiÃ³n "v17.0.12"
SpringBoot -- v3.5.6



# JWT Configuration
jwt.secret=p3u9FhZ@4!aB6nT$kX7rVq2^jP0zYwL&dH8sJm#QfR1tN*Zc5oGxE%lK9vU0bI



# =====================================================
# MicroServiceUsuario
# =====================================================

# Crear la imagen Docker
docker build -t microserviceusuario:1.0 .

# Levantar el contenedor
docker run -d -p 8080:8080 --name MicroServiceUsuario microserviceusuario:1.0


# =====================================================
# MicroServiceProveedores
# =====================================================

docker build -t microserviceproveedores:1.0 .
docker run -d -p 8081:8081 --name MicroServiceProveedores microserviceproveedores:1.0

# =====================================================
# MicroServiceProduccion
# =====================================================
docker build -t microserviceproduccion:1.0 .
docker run -d -p 8082:8082 --name MicroServiceProduccion microserviceproduccion:1.0

# =====================================================
# MicroServiceNotificacionesGmail
# =====================================================
docker build -t microservicenotificacionesgmail:1.0 .
docker run -d -p 8083:8083 --name MicroServiceNotificacionesGmail microservicenotificacionesgmail:1.0

# =====================================================
# MicroServiceGeneradorCodigo
# =====================================================
docker build -t microservicegeneradorcodigo:1.0 .
docker run -d -p 8084:8084 --name MicroServiceGeneradorCodigo microservicegeneradorcodigo:1.0

# =====================================================
# MicroServiceAuth
# =====================================================
docker build -t microserviceauth:1.0 .
docker run -d -p 8085:8085 --name MicroServiceAuth microserviceauth:1.0

# =====================================================
# MicroServiceApiarios
# =====================================================
docker build -t microserviceapiarios:1.0 .
docker run -d -p 8086:8086 --name MicroServiceApiarios microserviceapiarios:1.0

# =====================================================
# MicroServiceAlmacen
# =====================================================
docker build -t microservicealmacen:1.0 .
docker run -d -p 8087:8087 --name MicroServiceAlmacen microservicealmacen:1.0

# =====================================================
# Consejos Ãºtiles
# =====================================================
# Ver contenedores activos
docker ps

# Detener un contenedor
docker stop MicroServiceAuth

# Eliminar un contenedor
docker rm MicroServiceAuth


docker-compose up -d       

mvn clean package -DskipTests

docker system prune -a --volumes -f

docker build -t microservice_postgres -f Dockerfile.postgres .

docker exec -it ollama ollama pull gemma3:4b


curl.exe -X POST `
  -H "Authorization: Bearer eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiJhbmRyb296NzA2QGdtYWlsLmNvbSIsInJvbCI6IkFETUlOSVNUUkFET1IiLCJ1c3VhcmlvSWQiOjEsImVzdGFkbyI6ZmFsc2UsImlhdCI6MTc2MDY0MjQzOCwiZXhwIjoxNzYwNzI4ODM4fQ.0Gs3umr0chCCO90M4pCTwjfNDENitpBZrtY4xlMfpmePtUqZ5Uj2Q2PjmrG5sdfc" `
  -F "file=@C:\Users\andre\OneDrive\ImÃ¡genes\Capturas de pantalla\Captura de pantalla 2025-08-21 191639.png" `
  http://localhost:8089/api/files/upload


curl.exe -X GET `
  -H "Authorization: Bearer eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiJhbmRyb296NzA2QGdtYWlsLmNvbSIsInJvbCI6IkFETUlOSVNUUkFET1IiLCJ1c3VhcmlvSWQiOjEsImVzdGFkbyI6ZmFsc2UsImlhdCI6MTc2MDg0ODE4MiwiZXhwIjoxNzYwOTM0NTgyfQ.iveTn_LFkfe8cABh_WEWtZjuCHHPoYMNLQwHqrkdJkZ1hS7qsM4pOcLlvLPuinxo" `
  -o "C:\Users\andre\OneDrive\Escritorio\prueba_descargada.txt" `
  http://localhost:8089/api/files/view/FILE-20251019043005-ng0w#Z


curl.exe -X POST "http://localhost:8086/api/proveedores" ^
  -H "Authorization: Bearer eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiJhbmRyb296NzA2QGdtYWlsLmNvbSIsInJvbCI6IkFETUlOSVNUUkFET1IiLCJ1c3VhcmlvSWQiOjEsImVzdGFkbyI6ZmFsc2UsImlhdCI6MTc2MDg0ODE4MiwiZXhwIjoxNzYwOTM0NTgyfQ.iveTn_LFkfe8cABh_WEWtZjuCHHPoYMNLQwHqrkdJkZ1hS7qsM4pOcLlvLPuinxo" ^
  -F "nombreEmpresa=Mi Empresa Ejemplo" ^
  -F "numTelefono=1234567890" ^
  -F "nombreReprecentante=Juan PÃ©rez" ^
  -F "materialProvee=Miel y cera" ^
  -F "fotografia=@C:\Users\andre\OneDrive\ImÃ¡genes\Capturas de pantalla\Captura de pantalla 2025-08-21 191639.png"




//codigo esp32

import network
from umqtt.simple import MQTTClient
import time
import machine
import ujson

# =====================
# CONFIGURACIÃ“N GENERAL
# =====================
APIARIO_ID = "apiario_001"
DISPOSITIVO_ID = machine.unique_id()
DISPOSITIVO_ID_HEX = "".join("{:02x}".format(b) for b in DISPOSITIVO_ID)

ssid = "INFINITUMF116_EXT"
password = "X4s9xzFrsx"
mqtt_server = "192.168.1.101"

# =====================
# TOPICS MQTT
# =====================
TOPIC_REGISTRO = "apiarios/dispositivos/registro"
TOPIC_STATUS = f"apiarios/{APIARIO_ID}/status"
TOPIC_HUMEDAD_SUELO = f"apiarios/{APIARIO_ID}/humedad_suelo"
TOPIC_SENSOR_STATUS = f"apiarios/{APIARIO_ID}/sensor_status"

TOPIC_SERVO1 = f"apiarios/{APIARIO_ID}/comandos/servo1"
TOPIC_SERVO2 = f"apiarios/{APIARIO_ID}/comandos/servo2"

TOPIC_VENTILADOR = f"apiarios/{APIARIO_ID}/comandos/ventilador"   # Motor A
TOPIC_COMPUERTA = f"apiarios/{APIARIO_ID}/comandos/compuerta"     # Motor B

TOPIC_LUZ = f"apiarios/{APIARIO_ID}/comandos/luz"

# =====================
# HARDWARE
# =====================

# Sensor humedad con pull-down para evitar valores flotantes
sensor_pin = machine.Pin(34)
sensor_qc = machine.ADC(sensor_pin)
sensor_qc.atten(machine.ADC.ATTN_11DB)
sensor_qc.width(machine.ADC.WIDTH_12BIT)

# Servos
servo1 = machine.PWM(machine.Pin(15), freq=50)
servo2 = machine.PWM(machine.Pin(27), freq=50)

# Motores DC (H-Bridge)
# Motor A â†’ ventilador
A_IN1 = machine.Pin(5, machine.Pin.OUT)
A_IN2 = machine.Pin(18, machine.Pin.OUT)

# Motor B â†’ compuerta
B_IN1 = machine.Pin(19, machine.Pin.OUT)
B_IN2 = machine.Pin(25, machine.Pin.OUT)

# LED RGB
led_r = machine.Pin(21, machine.Pin.OUT)
led_g = machine.Pin(22, machine.Pin.OUT)
led_b = machine.Pin(23, machine.Pin.OUT)

# =====================
# CALIBRACIÃ“N SENSOR
# =====================
# Valores calibrados - AJUSTA ESTOS VALORES SEGÃšN TU SENSOR
SENSOR_SECO = 2500    # Valor cuando el sensor estÃ¡ completamente seco (al aire)
SENSOR_MOJADO = 1200  # Valor cuando el sensor estÃ¡ en agua
SENSOR_DESCONECTADO = 4095  # Valor cuando el sensor estÃ¡ desconectado

# =====================
# FUNCIONES
# =====================

def mover_servo(pwm, grados):
    duty = int((grados / 180) * 102) + 26
    pwm.duty(duty)
    print("Servo movido a:", grados)

# ----- Motor A (Ventilador) -----
def ventilador_on():
    A_IN1.value(1)
    A_IN2.value(0)
    print("Ventilador ENCENDIDO")

def ventilador_off():
    A_IN1.value(0)
    A_IN2.value(0)
    print("Ventilador APAGADO")

# ----- Motor B (Compuerta) -----
def compuerta_on():
    B_IN1.value(1)
    B_IN2.value(0)
    print("Compuerta ABIERTA")

def compuerta_off():
    B_IN1.value(0)
    B_IN2.value(0)
    print("Compuerta CERRADA")

# ----- Luz RGB -----
def luz_on():
    led_r.value(1)
    led_g.value(0)
    led_b.value(0)
    print("Luz ENCENDIDA")

def luz_off():
    led_r.value(0)
    led_g.value(0)
    led_b.value(0)
    print("Luz APAGADA")

def leer_humedad_corregida():
    """Lee el sensor y detecta si estÃ¡ desconectado"""
    # Leer mÃºltiples muestras para promediar
    muestras = []
    for _ in range(10):
        raw = sensor_qc.read()
        muestras.append(raw)
        time.sleep(0.01)
    
    raw_promedio = sum(muestras) / len(muestras)
    
    # Detectar si el sensor estÃ¡ desconectado
    if raw_promedio >= SENSOR_DESCONECTADO - 100:  # Margen de error
        return -1, raw_promedio  # -1 indica sensor desconectado
    
    # Calcular humedad con calibraciÃ³n
    if raw_promedio >= SENSOR_SECO:
        humedad = 0
    elif raw_promedio <= SENSOR_MOJADO:
        humedad = 100
    else:
        # FÃ³rmula lineal entre seco y mojado
        humedad = int((SENSOR_SECO - raw_promedio) * 100 / (SENSOR_SECO - SENSOR_MOJADO))
        humedad = max(0, min(100, humedad))
    
    return humedad, raw_promedio

# =====================
# MQTT CALLBACK
# =====================
def on_message(topic, msg):
    t = topic.decode()
    m = msg.decode().upper()
    print("Comando recibido:", t, m)

    # Servos
    if t == TOPIC_SERVO1:
        mover_servo(servo1, int(m))
    elif t == TOPIC_SERVO2:
        mover_servo(servo2, int(m))

    # Motores DC
    elif t == TOPIC_VENTILADOR:
        ventilador_on() if m == "ON" else ventilador_off()

    elif t == TOPIC_COMPUERTA:
        compuerta_on() if m == "ON" else compuerta_off()

    # Luz RGB
    elif t == TOPIC_LUZ:
        luz_on() if m == "ON" else luz_off()

# =====================
# CONEXIÃ“N
# =====================

def connect_wifi():
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    wlan.connect(ssid, password)
    print("Conectando a WiFi...")
    while not wlan.isconnected():
        time.sleep(0.5)
    print("Conectado:", wlan.ifconfig())

def connect_mqtt():
    client = MQTTClient(DISPOSITIVO_ID_HEX, mqtt_server)
    client.set_callback(on_message)
    client.connect()

    client.subscribe(TOPIC_SERVO1)
    client.subscribe(TOPIC_SERVO2)
    client.subscribe(TOPIC_VENTILADOR)
    client.subscribe(TOPIC_COMPUERTA)
    client.subscribe(TOPIC_LUZ)

    print("Suscrito a comandos MQTT")
    return client

def enviar_registro(client):
    registro = {
        "dispositivoId": DISPOSITIVO_ID_HEX,
        "apiarioId": APIARIO_ID,
        "tipo": "ESP32_QC_SENSOR",
        "sensores": ["humedad_suelo"],
        "actuadores": ["servo1", "servo2", "ventilador", "compuerta", "luz"],
        "timestamp": time.time()
    }

    try:
        client.publish(TOPIC_REGISTRO, ujson.dumps(registro), retain=True)
        print("Registro enviado")
    except Exception as e:
        print("Error al registrar:", e)

# =====================
# LOOP PRINCIPAL
# =====================
try:
    print("=" * 40)
    print("ðŸ SISTEMA APIARIO INTELIGENTE")
    print("ID:", DISPOSITIVO_ID_HEX)
    print("=" * 40)

    connect_wifi()
    client = connect_mqtt()

    enviar_registro(client)

    time.sleep(2)
    client.publish(TOPIC_STATUS, "online")

    while True:
        # Leer sensor con detecciÃ³n de desconexiÃ³n
        humedad, raw_promedio = leer_humedad_corregida()
        
        if humedad == -1:
            # Sensor desconectado
            print(f"âŒ SENSOR DESCONECTADO - Valor RAW: {raw_promedio}")
            client.publish(TOPIC_HUMEDAD_SUELO, "SENSOR_DESCONECTADO")
            client.publish(TOPIC_SENSOR_STATUS, "desconectado")
        else:
            # Sensor funcionando
            print(f"âœ… Valor RAW: {raw_promedio}, Humedad del suelo: {humedad}%")
            client.publish(TOPIC_HUMEDAD_SUELO, str(humedad))
            client.publish(TOPIC_SENSOR_STATUS, "conectado")

        client.check_msg()
        time.sleep(5)

except Exception as e:
    print("ERROR FATAL:", e)
    time.sleep(5)
    machine.reset()
